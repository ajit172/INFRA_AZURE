trigger: none

pool:
  name: Default

steps:
  # --- SonarQube Analysis ---
  - task: SonarQubePrepare@8
    inputs:
      SonarQube: 'sonarqube service connection'
      scannerMode: 'cli'
      configMode: 'manual'
      cliProjectKey: 'my_app'
      cliProjectName: 'my_application'
      cliSources: '.'
      # ‚ùå Don't add sonar.branch.name (Community Edition limitation)

  - task: SonarQubeAnalyze@8
    inputs:
      jdkversion: 'JAVA_HOME_17_X64'

  - task: SonarQubePublish@8
    inputs:
      pollingTimeoutSec: '300'

  # --- Terraform Workflow ---
  - task: TerraformTask@5
    displayName: 'Terraform Init'
    inputs:
      provider: 'azurerm'
      command: 'init'
      backendServiceArm: 'ajit123'
      backendAzureRmResourceGroupName: 'rg'
      backendAzureRmStorageAccountName: 'remotebackend1'
      backendAzureRmContainerName: 'vm0007'
      backendAzureRmKey: 'tfstate'

  - task: TerraformTask@5
    displayName: 'Terraform Validate'
    inputs:
      provider: 'azurerm'
      command: 'validate'

  - task: TerraformTask@5
    displayName: 'Terraform Plan'
    inputs:
      provider: 'azurerm'
      command: 'plan'
      environmentServiceNameAzureRM: 'ajit123'

  # Optional manual approval step (uncomment if needed)
  # - task: ManualValidation@1
  #   inputs:
  #     notifyUsers: 'ajitk661@gmail.com'
  #     approvers: 'ajitk661@gmail.com'
  #     instructions: 'please check the code'

  - task: TerraformTask@5
    displayName: 'Terraform Apply'
    inputs:
      provider: 'azurerm'
      command: 'apply'
      environmentServiceNameAzureRM: 'ajit123'